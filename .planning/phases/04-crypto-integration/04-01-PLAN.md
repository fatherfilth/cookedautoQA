---
phase: 04-crypto-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/pages/SwappedIntegrationPage.ts
  - tests/helpers/crypto-config.ts
  - tests/crypto/swapped-buy-flow.spec.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Swapped.com buy crypto page is reachable from cooked.com and iframe loads visibly"
    - "Crypto buy flow progresses through steps (amount entry, payment method) and stops before real purchase"
    - "Each test runs in an isolated browser context with no wallet state pollution"
  artifacts:
    - path: "tests/pages/SwappedIntegrationPage.ts"
      provides: "Page object for crypto buy page with Swapped.com iframe locators"
      min_lines: 40
    - path: "tests/helpers/crypto-config.ts"
      provides: "Environment-based crypto page configuration"
      exports: ["cryptoConfig"]
    - path: "tests/crypto/swapped-buy-flow.spec.ts"
      provides: "CRYPTO-01 and CRYPTO-02 tests"
      min_lines: 50
    - path: ".env.example"
      provides: "Crypto-related environment variable documentation"
      contains: "CRYPTO_BUY_PATH"
  key_links:
    - from: "tests/crypto/swapped-buy-flow.spec.ts"
      to: "tests/pages/SwappedIntegrationPage.ts"
      via: "import SwappedIntegrationPage"
      pattern: "import.*SwappedIntegrationPage"
    - from: "tests/crypto/swapped-buy-flow.spec.ts"
      to: "tests/helpers/crypto-config.ts"
      via: "import cryptoConfig"
      pattern: "import.*cryptoConfig"
    - from: "tests/pages/SwappedIntegrationPage.ts"
      to: "tests/pages/BasePage.ts"
      via: "extends BasePage"
      pattern: "extends BasePage"
    - from: "tests/crypto/swapped-buy-flow.spec.ts"
      to: "iframe[src*=\"connect.swapped.com\"]"
      via: "frameLocator for Swapped.com iframe content interaction"
      pattern: "frameLocator.*swapped"
---

<objective>
Create SwappedIntegrationPage page object and crypto buy flow tests that validate the Swapped.com iframe loads on cooked.com and the purchase flow progresses through steps, stopping before any real transaction.

Purpose: CRYPTO-01 and CRYPTO-02 are the final test coverage requirements before CI/CD automation (Phase 5). The Swapped.com crypto buy flow is identified as a known fragile area in PROJECT.md. These monitoring tests detect breakages in the crypto on-ramp integration.

Output: SwappedIntegrationPage page object, crypto config helper, and 2 test cases (iframe load + buy flow progression) in tests/crypto/ directory.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-crypto-integration/04-RESEARCH.md

# Prior phase artifacts needed for patterns
@tests/pages/BasePage.ts (extend for SwappedIntegrationPage)
@tests/pages/GameDetailPage.ts (iframe locator pattern reference)
@tests/pages/ChatPage.ts (POM structure with .or() chains reference)
@tests/game/slot-launch.spec.ts (frameLocator + iframe content detection pattern)
@tests/social/tipping-flow.spec.ts (test.step() + stop-before-payment pattern)
@tests/helpers/game-config.ts (environment-based config pattern)
@tests/helpers/test-config.ts (timeout constants)
@.env.example (existing env vars to append to)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create crypto config helper and SwappedIntegrationPage page object</name>
  <files>
    tests/helpers/crypto-config.ts
    tests/pages/SwappedIntegrationPage.ts
    .env.example
  </files>
  <action>
**1. Create `tests/helpers/crypto-config.ts`:**

Follow the same pattern as `tests/helpers/game-config.ts` (environment-first with fallback defaults).

```typescript
export const cryptoConfig = {
  buyPath: process.env.CRYPTO_BUY_PATH || '/crypto/buy',
  iframeSrcPattern: process.env.CRYPTO_IFRAME_SRC || 'connect.swapped.com',
} as const;
```

- `buyPath`: The page on cooked.com that embeds the Swapped.com widget. Default `/crypto/buy` per research. This is a TODO placeholder — actual path needs live site inspection to confirm.
- `iframeSrcPattern`: Substring to match in the Swapped.com iframe `src` attribute. Default `connect.swapped.com` per Swapped.com docs (https://docs.swapped.com/swapped-connect/connect-integration/iframe-initialization).

Use `as const` for type safety (same as game-config.ts).

**2. Create `tests/pages/SwappedIntegrationPage.ts`:**

Extend BasePage following the same POM pattern as ChatPage.ts (locators as readonly properties, .or() fallback chains, override waitForReady()).

```
class SwappedIntegrationPage extends BasePage:
  - protected path: reads from cryptoConfig.buyPath
  - readonly swappedIframe: Locator — page.locator(`iframe[src*="${cryptoConfig.iframeSrcPattern}"]`).or(page.getByTestId('swapped-iframe'))
  - readonly swappedFrame: FrameLocator — page.frameLocator(`iframe[src*="${cryptoConfig.iframeSrcPattern}"], iframe`).first() (compound CSS selector, same pattern as slot-launch.spec.ts to handle fallback)
  - readonly amountInput: Locator — swappedFrame.locator('input[type="number"], input[type="text"], input[placeholder*="amount" i]').first() (broad selector, TODO refine after live inspection)
  - readonly paymentMethodButton: Locator — swappedFrame.locator('button:has-text("Credit"), button:has-text("Card"), [data-testid="payment-method"]').first()
  - readonly buyButton: Locator — swappedFrame.locator('button:has-text("Buy"), button:has-text("Continue"), button[type="submit"]').first() (DO NOT CLICK — stop-before-purchase)

  Methods:
  - async enterAmount(amount: string): fills amountInput with the given amount string
  - async selectPaymentMethod(): clicks paymentMethodButton (first available option)

  Override waitForReady():
  - Call super.waitForReady() first
  - Then wait for swappedIframe to be visible with 15s timeout (iframe element must exist in DOM)
  - Then wait for swappedFrame.locator('body').waitFor({ state: 'visible', timeout: 30_000 }) to confirm iframe internal content loaded (same broad approach as game launch tests)
```

Important implementation notes:
- All locators that interact with iframe CONTENT must use the FrameLocator (swappedFrame), not the Locator (swappedIframe). The Locator is only for checking iframe element visibility.
- Use compound CSS selector in frameLocator (not .or()) per Phase 2 decision: "FrameLocator with compound CSS selector instead of .or() method (API limitation workaround)".
- Add TODO comments on all selectors noting they need refinement after live site inspection.
- Use .js extensions in all imports (ESM module compliance per 01-01 decision).

**3. Update `.env.example`:**

Append a crypto section after the existing game ID variables:

```
# Crypto integration (Phase 4)
# Path to crypto buy page on cooked.com — inspect live site to confirm
CRYPTO_BUY_PATH=/crypto/buy
# Swapped.com iframe src pattern for detection
CRYPTO_IFRAME_SRC=connect.swapped.com
```
  </action>
  <verify>
    Run `npx tsc --noEmit` from project root — TypeScript compiles without errors.
    Confirm tests/helpers/crypto-config.ts exports cryptoConfig with buyPath and iframeSrcPattern.
    Confirm tests/pages/SwappedIntegrationPage.ts extends BasePage, imports crypto-config.ts.
    Confirm .env.example contains CRYPTO_BUY_PATH and CRYPTO_IFRAME_SRC lines.
    Grep for "networkidle" and "waitForTimeout" in new files — must return zero results.
  </verify>
  <done>
    SwappedIntegrationPage page object exists extending BasePage with Swapped.com iframe locators (swappedIframe, swappedFrame, amountInput, paymentMethodButton, buyButton) and methods (enterAmount, selectPaymentMethod). Crypto config helper provides environment-based configuration. .env.example documents crypto variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Swapped.com buy flow tests (CRYPTO-01 and CRYPTO-02)</name>
  <files>
    tests/crypto/swapped-buy-flow.spec.ts
  </files>
  <action>
Create `tests/crypto/swapped-buy-flow.spec.ts` with two tests covering CRYPTO-01 and CRYPTO-02.

Follow the established test patterns:
- Import from '../pages/SwappedIntegrationPage.js' and '../helpers/crypto-config.js' (ESM .js extensions)
- Use test.describe() to group crypto tests
- Use test.step() for multi-stage flows (same as tipping-flow.spec.ts)
- Tag tests: @critical @crypto

**Test 1: CRYPTO-01 — Swapped.com buy crypto flow is reachable and loads correctly**

```
test('Swapped.com crypto buy iframe loads on cooked.com @critical @crypto')
```

Steps:
1. `Navigate to crypto buy page` — Create SwappedIntegrationPage, call open(). This triggers goto + waitForReady which already waits for iframe visibility and body load.
2. `Verify iframe element exists with correct source` — Assert swappedIframe is visible. Get the iframe's `src` attribute and assert it contains cryptoConfig.iframeSrcPattern (not empty, not about:blank).
3. `Verify iframe content loaded` — Use swappedFrame.locator('input, button, form').first() and assert it's visible with 10s timeout. This confirms the Swapped.com widget rendered interactive elements (not just a blank body).

**Test 2: CRYPTO-02 — Crypto buy flow progresses through steps (stop before purchase)**

```
test('crypto buy flow progresses through steps and stops before purchase @critical @crypto')
```

Steps (using test.step() for structured reporting, same as tipping-flow.spec.ts):
1. `Navigate to crypto buy page` — Create SwappedIntegrationPage, call open().
2. `Enter purchase amount` — Call cryptoPage.enterAmount('50'). Assert amountInput has value (use inputValue() or toHaveValue()).
3. `Select payment method` — Call cryptoPage.selectPaymentMethod(). This clicks the first available payment method button. After clicking, wait briefly for UI to update — assert some visual change occurred (e.g., a new element becomes visible, or a "next step" indicator appears). Use a broad locator: swappedFrame.locator('[aria-current], [data-selected], .selected, [class*="active"]').first() with a 5s timeout. If this broad locator doesn't match, that's acceptable — add TODO comment noting payment method selection needs refinement after live inspection.
4. `Verify buy button is ready (STOP HERE)` — Assert buyButton is visible. Assert buyButton is enabled. Add explicit comment: `// STOP HERE: Do NOT click buy button. Per PROJECT.md: "No real purchases or destructive actions"`. Do NOT call .click() on buyButton.

Important:
- The STOP point is consistent with Phase 3 tipping: verify the final action button is visible and enabled, but do NOT click it.
- If step 3 (payment method) fails due to unknown selectors, the test still validates steps 1-2 (iframe loads, amount entry works). Add TODO comment for step 3 refinement.
- Wrap the describe block with `test.describe('Swapped.com Crypto Buy Flow', () => { ... })`.
- Use fresh page context per test (Playwright default) — this satisfies Success Criteria 3 (context isolation prevents wallet state pollution). No special isolation setup needed since Playwright creates a new BrowserContext per test by default.
- Add a file-level JSDoc comment explaining: tests validate crypto flow structure without executing real transactions, selectors are broad until live site inspection, and context isolation is handled by Playwright defaults.
  </action>
  <verify>
    Run `npx tsc --noEmit` — TypeScript compiles without errors.
    Run `npx playwright test --grep @crypto --list` — should list 2 tests in 1 file.
    Grep for ".click()" calls on buyButton in the spec file — must return zero results (stop-before-purchase enforced).
    Grep for "networkidle" and "waitForTimeout" in spec file — must return zero results.
    Confirm both tests import SwappedIntegrationPage and cryptoConfig.
    Confirm test.step() is used in the CRYPTO-02 test for multi-stage reporting.
  </verify>
  <done>
    2 crypto tests exist: CRYPTO-01 validates iframe loads with correct source and interactive content, CRYPTO-02 validates flow progression (amount entry, payment method, buy button ready) with stop-before-purchase enforcement. Both tagged @critical @crypto. Buy button is verified visible and enabled but never clicked.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx playwright test --grep @crypto --list` shows exactly 2 tests in 1 file
3. No occurrences of `networkidle`, `waitForTimeout`, or `buyButton.click()` in any new file
4. SwappedIntegrationPage extends BasePage (inheritance chain intact)
5. All imports use .js extensions (ESM compliance)
6. .env.example has CRYPTO_BUY_PATH and CRYPTO_IFRAME_SRC documented
7. All new locators use .or() chains or compound CSS selectors (no bare CSS class selectors)
</verification>

<success_criteria>
- CRYPTO-01: Test exists that navigates to crypto buy page, asserts Swapped.com iframe is visible with valid src, and confirms iframe content loaded with interactive elements
- CRYPTO-02: Test exists that enters amount, selects payment method, and verifies buy button is ready WITHOUT clicking it
- SwappedIntegrationPage page object extends BasePage with iframe-aware locators and methods
- Crypto config helper reads from environment variables with fallback defaults
- Browser context isolation confirmed by Playwright's default per-test context (no shared state)
- All patterns consistent with Phases 1-3 (POM, .or() chains, frameLocator, test.step(), stop-before-payment, ESM, no networkidle)
</success_criteria>

<output>
After completion, create `.planning/phases/04-crypto-integration/04-01-SUMMARY.md`
</output>
