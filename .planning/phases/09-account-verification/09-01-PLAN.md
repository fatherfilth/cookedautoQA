---
phase: 09-account-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/auth/auth.setup.ts
  - tests/helpers/verification-data.ts
autonomous: true
must_haves:
  truths:
    - "Auth setup completes details verification form after registration"
    - "Verification form is filled with fake data (name, DOB, address) without manual intervention"
    - "storageState saved after verification reflects a verified account"
  artifacts:
    - path: "tests/helpers/verification-data.ts"
      provides: "Fake identity data for verification form"
    - path: "tests/auth/auth.setup.ts"
      provides: "Registration + verification flow in setup project"
      contains: "verification"
  key_links:
    - from: "tests/auth/auth.setup.ts"
      to: "/account/settings?account_tab=verification&verification_modal=details"
      via: "page.goto after registration"
      pattern: "verification_modal=details"
---

<objective>
Add details verification form completion to the auth setup project so every test run creates a fully verified account.

Purpose: Unverified accounts see a "Set your details" modal on game pages, blocking game iframe tests. Completing verification in setup enables real game iframe assertions in Plan 02.

Output: Updated auth.setup.ts that registers, verifies, and saves storageState for a fully verified account. New verification-data.ts helper with fake identity data.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@tests/auth/auth.setup.ts
@tests/helpers/test-config.ts
@playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create verification data helper and extend auth setup with verification form completion</name>
  <files>tests/helpers/verification-data.ts, tests/auth/auth.setup.ts</files>
  <action>
1. Create `tests/helpers/verification-data.ts` with a `getVerificationData()` function that returns fake identity data:
   - First name: "Smoke"
   - Last name: "Test"
   - Date of birth: a valid adult DOB (e.g., "01", "01", "1990" — day, month, year as separate fields or a single date string depending on form structure)
   - Address line 1: "123 Test Street"
   - City: "London"
   - Postcode: "SW1A 1AA"
   - Country: keep whatever default is pre-selected (likely UK/GB)
   Export the function. Use simple hardcoded values — no randomization needed since accounts are disposable.

2. Extend `tests/auth/auth.setup.ts` to add verification form completion AFTER the existing registration and auth verification steps, but BEFORE `storageState` is saved:
   - After the `expect(authIndicator).toBeVisible()` line, add a new section:
   - Navigate to the verification form: `await page.goto('/account/settings?account_tab=verification&verification_modal=details');`
   - Wait for the verification form/modal to appear (look for form fields like name, DOB, or a heading containing "details" or "verification")
   - Import and use `getVerificationData()` to fill the form fields
   - Fill first name, last name, DOB fields, address line 1, city, postcode
   - For DOB: the form likely has separate day/month/year dropdowns or inputs — inspect what appears and fill accordingly. Use `.selectOption()` for dropdowns, `.fill()` for text inputs
   - Submit the form (look for a submit/save/confirm button)
   - Wait for success indication: form closes, success toast appears, or URL changes
   - Use try/catch around the entire verification block — if verification fails (e.g., form structure changed), log a warning but still save storageState so tests can run (they'll just see the modal). This graceful degradation prevents total test suite failure.
   - Increase the setup timeout from 60_000 to 90_000 to accommodate the extra navigation and form fill

   Important implementation notes:
   - The verification form URL is: `/account/settings?account_tab=verification&verification_modal=details`
   - This is a known live site pattern from PROJECT.md
   - The form likely has standard input fields (text inputs for name/address, dropdowns or date picker for DOB)
   - Use role-based selectors where possible, fall back to input type/name attributes
   - Add console.log statements for debugging: "Auth setup: starting verification", "Auth setup: verification complete" (or "verification skipped" on failure)
  </action>
  <verify>
  Run `npx tsc --noEmit` to verify TypeScript compiles. Run `npx playwright test --list` to verify test count is still 18 (1 setup + 17 specs). Visually inspect auth.setup.ts to confirm verification section is placed before storageState save.
  </verify>
  <done>
  auth.setup.ts registers a fresh account, navigates to verification form, fills it with fake data, submits, and saves storageState. verification-data.ts exports fake identity data. TypeScript compiles cleanly. Test list unchanged at 18.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npx playwright test --list` shows 18 tests (1 setup + 17 specs)
- `tests/auth/auth.setup.ts` contains verification form navigation and fill logic
- `tests/helpers/verification-data.ts` exists with exported fake data function
- storageState save (`page.context().storageState(...)`) comes AFTER verification attempt
- Verification block is wrapped in try/catch for graceful degradation
- Setup timeout is 90_000 (increased from 60_000)
</verification>

<success_criteria>
Auth setup project registers a fresh account AND completes the details verification form with fake data before saving storageState. The verification step is resilient (try/catch) so existing tests are not broken if the form structure changes.
</success_criteria>

<output>
After completion, create `.planning/phases/09-account-verification/09-01-SUMMARY.md`
</output>
