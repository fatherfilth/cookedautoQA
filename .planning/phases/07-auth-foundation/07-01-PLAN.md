---
phase: 07-auth-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/auth/auth.setup.ts
  - playwright.config.ts
  - .gitignore
  - .env.example
autonomous: true
must_haves:
  truths:
    - "Each test run registers a unique disposable account before any test spec runs"
    - "Registration produces an authenticated browser session with cookies and localStorage"
    - "Playwright storageState is saved to .auth/user.json after successful registration"
    - "All test specs load the saved storageState and run as an authenticated user"
    - "No test spec needs to log in or register on its own — setup project handles auth"
  artifacts:
    - path: "tests/auth/auth.setup.ts"
      provides: "Playwright setup project that registers smoketest+{timestamp}@totempowered.com, logs in, and saves storageState"
      contains: "setup.*storageState"
    - path: "playwright.config.ts"
      provides: "Setup project definition and authenticated project dependency"
      contains: "setup.*dependencies"
    - path: ".auth/user.json"
      provides: "Saved browser storageState (cookies + localStorage) — created at runtime, gitignored"
  key_links:
    - from: "tests/auth/auth.setup.ts"
      to: ".auth/user.json"
      via: "page.context().storageState({ path })"
      pattern: "storageState.*\\.auth/user\\.json"
    - from: "playwright.config.ts"
      to: "tests/auth/auth.setup.ts"
      via: "setup project testMatch"
      pattern: "testMatch.*auth\\.setup\\.ts"
    - from: "playwright.config.ts"
      to: ".auth/user.json"
      via: "storageState in chromium project use block"
      pattern: "storageState.*\\.auth/user\\.json"
---

<objective>
Create a Playwright setup project that registers a fresh disposable account on each test run and saves the authenticated session as storageState for all downstream test specs.

Purpose: AUTH-05 and AUTH-06 — eliminate manual credential management and enable all auth-gated tests to run with a real authenticated session. Every CI run is self-contained: register, authenticate, save state, run tests.

Output: `tests/auth/auth.setup.ts` (setup project), updated `playwright.config.ts` (setup + authenticated project wiring), updated `.gitignore` and `.env.example`.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@playwright.config.ts
@tests/pages/RegistrationPage.ts
@tests/pages/LoginPage.ts
@tests/auth/registration.spec.ts
@tests/auth/login.spec.ts
@tests/auth/session-persistence.spec.ts
@.gitignore
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth setup project that registers a fresh account and saves storageState</name>
  <files>
    tests/auth/auth.setup.ts
    .gitignore
    .env.example
  </files>
  <action>
Create `tests/auth/auth.setup.ts` as a Playwright setup file using `import { test as setup } from '@playwright/test'`.

**Setup flow:**

1. Generate unique email: `smoketest+${Date.now()}@totempowered.com`
2. Use password: `testtest123`
3. Navigate to homepage (`/`)
4. Click the Register button in the nav bar to open the auth dialog (same pattern as `RegistrationPage.open()`)
5. Wait for `div[role="dialog"]` to become visible
6. Fill the registration form:
   - Email field: `authDialog.getByRole('textbox', { name: /email/i }).or(authDialog.locator('input[type="email"], input[name="email"]').first())`
   - Password field: `authDialog.locator('input[type="password"]').first()`
   - Username field (if visible): `authDialog.getByRole('textbox', { name: /username|display name/i })` — fill with `smoketest` if field exists
   - Terms checkbox (if visible): `authDialog.getByRole('checkbox', { name: /terms|agree/i }).or(authDialog.locator('input[type="checkbox"]').first())` — check it if present
7. Click the submit button: `authDialog.getByRole('button', { name: 'Create Account' }).or(authDialog.locator('button[type="submit"]').first())`
8. Wait for successful registration — use `Promise.race` with:
   - Auth dialog closes: `authDialog.waitFor({ state: 'hidden', timeout: 30_000 })`
   - URL changes to account/profile page: `page.waitForURL('**/account**', { timeout: 30_000 })`
   - URL redirects to homepage: `page.waitForURL('**/', { timeout: 30_000 })`
9. Verify authenticated state — assert at least one auth indicator is visible:
   - `page.getByRole('button', { name: /log out|sign out|account|profile/i })`
   - `.or(page.getByText(/welcome|account|profile/i))`
   - `.or(page.locator('[class*="avatar"], [class*="user"], [class*="profile"]').first())`
   - Use `toBeVisible({ timeout: 15_000 })`
10. Save storageState: `await page.context().storageState({ path: '.auth/user.json' })`
11. Log the email used to console for debugging: `console.log('Auth setup: registered', email)`

**Important details:**
- Import `test as setup` and `expect` from `@playwright/test` — this is Playwright's standard pattern for setup projects
- Use `setup('register and authenticate', async ({ page }) => { ... })` not `test()`
- Do NOT use RegistrationPage page object — the setup script should be self-contained with inline selectors (it runs in a different project context, and importing page objects adds coupling)
- The `.auth/` directory will be created automatically by Playwright's `storageState()` call
- Add a `setup.setTimeout(60_000)` at the top of the describe/test for generous timeout — registration on live site may be slow
- If registration fails (e.g., email already exists), catch and retry with a new timestamp: `smoketest+${Date.now() + 1}@totempowered.com`

**Update `.gitignore`:** Add `.auth/` line to exclude saved auth state from version control (contains session tokens).

**Update `.env.example`:** Add a comment block explaining that `TEST_USER_EMAIL` and `TEST_USER_PASSWORD` are no longer needed — auth setup auto-registers. Keep the vars documented but mark them as `# (optional — auth setup auto-registers per run)`.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm the setup file compiles without TypeScript errors. Verify `.gitignore` contains `.auth/` entry. Verify `.env.example` has updated auth documentation.
  </verify>
  <done>
`tests/auth/auth.setup.ts` exists with the complete registration + storageState save flow. `.gitignore` excludes `.auth/`. `.env.example` documents the auto-registration approach. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire setup project into playwright.config.ts so all tests use authenticated state</name>
  <files>
    playwright.config.ts
  </files>
  <action>
Update `playwright.config.ts` to use Playwright's setup project pattern:

**Replace the existing `projects` array** with:

```typescript
projects: [
  // Auth setup — runs first, registers fresh account, saves storageState
  {
    name: 'setup',
    testMatch: /auth\.setup\.ts/,
  },
  // Main test suite — depends on setup, uses saved auth state
  {
    name: 'chromium',
    use: {
      ...devices['Desktop Chrome'],
      storageState: '.auth/user.json',
    },
    dependencies: ['setup'],
  },
],
```

**Key details:**
- The `setup` project uses `testMatch` to match only `auth.setup.ts` — it won't run regular spec files
- The `chromium` project gets `storageState: '.auth/user.json'` in its `use` block — every test spec starts with the authenticated session
- The `chromium` project has `dependencies: ['setup']` — Playwright ensures setup runs first
- The `testDir` remains `'./tests'` — no change needed

**Do NOT change:**
- Reporter configuration (html, list, json)
- Timeouts (action: 15s, navigation: 30s, test: 60s)
- Retries (1 local, 2 CI)
- Workers configuration
- Headless configuration
- Artifact settings (screenshot, video, trace)
  </action>
  <verify>
Run `npx playwright test --list` to confirm:
1. The setup project appears in the test list as `[setup]` with `auth.setup.ts`
2. The chromium project lists all existing test specs
3. No test specs are missing from the list

Run `npx tsc --noEmit` to confirm TypeScript still compiles cleanly.
  </verify>
  <done>
`playwright.config.ts` has a `setup` project that runs `auth.setup.ts` first, and a `chromium` project with `storageState: '.auth/user.json'` and `dependencies: ['setup']`. All existing tests are still listed under the chromium project. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **TypeScript compilation:** `npx tsc --noEmit` passes with zero errors
2. **Test listing:** `npx playwright test --list` shows setup project + all 16 existing test specs under chromium
3. **Setup file structure:** `tests/auth/auth.setup.ts` uses `setup()` function pattern with storageState save
4. **Config wiring:** `playwright.config.ts` has setup project with `testMatch`, chromium project with `storageState` and `dependencies`
5. **Gitignore:** `.auth/` is listed in `.gitignore`
6. **No regressions:** The registration.spec.ts (stop-before-payment pattern) still exists unchanged — it validates form structure independently of the setup project

NOTE: Full end-to-end verification (actually running registration against live site) will happen in Phase 8 when tests are executed. This plan ensures the infrastructure is correctly wired. If the live site registration flow has unexpected DOM differences, selectors can be adjusted in Phase 8.
</verification>

<success_criteria>
- `tests/auth/auth.setup.ts` exists and compiles — contains `setup('register and authenticate', ...)` with storageState save to `.auth/user.json`
- `playwright.config.ts` defines `setup` project (testMatch auth.setup.ts) and `chromium` project (storageState + dependencies)
- `.auth/` is gitignored
- `.env.example` documents auto-registration
- `npx tsc --noEmit` passes
- `npx playwright test --list` shows both projects with correct test files
</success_criteria>

<output>
After completion, create `.planning/phases/07-auth-foundation/07-01-SUMMARY.md`
</output>
