---
phase: 03-social-live-features
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - tests/social/tipping-flow.spec.ts
  - tests/social/promotions.spec.ts
autonomous: true

must_haves:
  truths:
    - "Tipping flow initiates, confirms, and reaches success state (stop before real transaction)"
    - "\"Latest and Greatest\" promotional messages display on the appropriate page"
  artifacts:
    - path: "tests/social/tipping-flow.spec.ts"
      provides: "Tipping flow end-to-end test with stop-before-payment"
      contains: "@critical @social"
    - path: "tests/social/promotions.spec.ts"
      provides: "Promotional content display test"
      contains: "@social"
  key_links:
    - from: "tests/social/tipping-flow.spec.ts"
      to: "tests/pages/ChatPage.ts"
      via: "import ChatPage for tipping locators"
      pattern: "import.*ChatPage"
    - from: "tests/social/promotions.spec.ts"
      to: "tests/pages/LobbyPage.ts"
      via: "import LobbyPage for promotional section"
      pattern: "import.*LobbyPage"
---

<objective>
Create tipping flow and promotional content tests (SOCIAL-03, SOCIAL-04) validating that tipping works step-by-step (stop before payment) and that "Latest and Greatest" promotions display correctly.

Purpose: Tipping is a social engagement and monetization feature — if broken, users can't reward streamers/hosts. Promotional content drives engagement — if missing, key marketing content is invisible to users. Both are known fragile areas on cooked.com.
Output: 2 test spec files in tests/social/ covering tipping flow and promotional content display.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-social-live-features/03-01-SUMMARY.md
@tests/pages/ChatPage.ts
@tests/pages/LobbyPage.ts
@tests/pages/BasePage.ts
@tests/helpers/test-config.ts
@playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tipping flow test with stop-before-payment (SOCIAL-03)</name>
  <files>tests/social/tipping-flow.spec.ts</files>
  <action>
Create `tests/social/tipping-flow.spec.ts` for SOCIAL-03:

- Import `test, expect` from `@playwright/test`
- Import `ChatPage` from `../pages/ChatPage.js`

- Single test: `'tipping flow works end-to-end (initiate → confirm → success state) @critical @social'`

- Use `test.step()` for each stage of the flow (provides structured reporting and shows where flow breaks):

**Step 1 — Navigate to chat page:**
- Create ChatPage and open: `const chatPage = new ChatPage(page); await chatPage.open();`
- Assert chat container is visible: `await expect(chatPage.chatContainer).toBeVisible({ timeout: 10_000 });`

**Step 2 — Initiate tip:**
- Click tip button: `await chatPage.clickTipButton();`
- Assert tip modal appears: `await expect(chatPage.tipModal).toBeVisible({ timeout: 5_000 });`

**Step 3 — Select tip amount:**
- Select $5 tip: `await chatPage.selectTipAmount('5');`
- Assert selected amount displays correctly: `await expect(chatPage.selectedTipAmount).toBeVisible();`
- Add TODO: `// TODO: Verify selected amount text after inspecting actual tip amount UI pattern`

**Step 4 — Confirm tip (opens confirmation):**
- Click confirm: `await chatPage.clickConfirmTip();`
- Assert confirmation dialog appears: `await expect(chatPage.tipConfirmationDialog).toBeVisible({ timeout: 5_000 });`
- Assert confirmation contains relevant text: `await expect(chatPage.tipConfirmationDialog).toContainText(/.+/);` — at minimum verify non-empty

**Step 5 — Verify submit button ready (STOP HERE):**
- Assert submit button is visible and enabled: `await expect(chatPage.submitTipButton).toBeVisible();` and `await expect(chatPage.submitTipButton).toBeEnabled();`
- **CRITICAL: DO NOT click submitTipButton** — stop-before-payment pattern prevents real transactions
- Add explicit comment: `// STOP HERE: Do NOT click submit. Test validates flow structure without executing real transaction. Per PROJECT.md: "No real purchases or destructive actions"`

**Safety enforcement:**
- The test file must NOT contain `submitTipButton.click()` anywhere
- Verify button state (visible + enabled) confirms the flow reached its final pre-transaction state

Tag: `@critical @social`

Follow established stop-before-payment pattern from AUTH-03 registration test (02-03-SUMMARY.md).
  </action>
  <verify>
Run `npx playwright test tests/social/tipping-flow.spec.ts --list` — test listed.
Run `npm run typecheck` — no TypeScript errors.
Verify file does NOT contain `submitTipButton.click()` (stop-before-payment enforced).
Verify test uses test.step() for structured reporting.
  </verify>
  <done>
tipping-flow.spec.ts: Test listed, uses test.step() for 5 flow stages (navigate, initiate, select amount, confirm, verify submit ready). Stop-before-payment enforced — submitTipButton.click() does NOT appear in file. Tagged @critical @social. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create promotional content display test (SOCIAL-04)</name>
  <files>tests/social/promotions.spec.ts</files>
  <action>
Create `tests/social/promotions.spec.ts` for SOCIAL-04:

- Import `test, expect` from `@playwright/test`
- Import `LobbyPage` from `../pages/LobbyPage.js`

- Single test: `'"Latest and Greatest" promotional messages display @social'`

- Navigate to lobby/homepage (promotions most likely appear there): `const lobbyPage = new LobbyPage(page); await lobbyPage.open();`

- Locate promotional section using flexible selectors (promotions may use various patterns):
  ```typescript
  const promoSection = page.getByTestId('promotions').or(
    page.getByRole('region', { name: /latest|promotions|featured|greatest/i })
  ).or(
    page.locator('[data-testid*="promo"], [class*="promo"], section:has-text("Latest")')
  );
  ```
  Add TODO: `// TODO: Refine promo section selector after inspecting live site. Check lobby, homepage, and dedicated promotions page.`

- Wait for promotional section to appear with generous timeout (may load asynchronously or after main content): `await expect(promoSection).toBeVisible({ timeout: 15_000 });`

- Locate promotional items within the section:
  ```typescript
  const promoItems = promoSection.locator('[data-testid*="promo-card"], article, [class*="promo-item"], [class*="card"]').or(
    promoSection.locator('> *')
  );
  ```

- Assert at least one promotional item is visible: `await expect(promoItems.first()).toBeVisible();`

- Assert promotional content has substance (not empty/placeholder):
  ```typescript
  const firstPromo = promoItems.first();
  const promoText = await firstPromo.textContent();
  expect(promoText).toBeTruthy();
  expect(promoText!.trim().length).toBeGreaterThan(0);
  ```

- Do NOT assert specific promotional text (research pitfall 5 — promotions may be A/B tested, personalized, or time-based). Test structure and presence, not specific content.

- Add comment: `// Validates promotional content section is present and populated. Does not assert specific promo text since promotions may be A/B tested, personalized, or time-limited.`

Tag: `@social` (not @critical — promotional content absence is less severe than chat/tipping failures)

Note: If promotions don't appear on the lobby page, the test may need to navigate to a dedicated promotions page. Add TODO: `// TODO: If promotions are not on lobby page, update to navigate to dedicated promotions/offers page`
  </action>
  <verify>
Run `npx playwright test tests/social/promotions.spec.ts --list` — test listed.
Run `npm run typecheck` — no TypeScript errors.
Run `npx playwright test --grep @social --list` — all 4 social tests appear (chat-connection, chat-messages, tipping-flow, promotions).
Verify no specific promotional text assertions (flexible pattern matching only).
  </verify>
  <done>
promotions.spec.ts: Test listed, navigates to lobby, locates promotional section with flexible selectors, asserts at least one promo item visible with non-empty text. No specific promo text assertions. Tagged @social. TypeScript compiles.
All 4 social tests (SOCIAL-01 through SOCIAL-04) appear when filtered by @social tag.
  </done>
</task>

</tasks>

<verification>
- tests/social/tipping-flow.spec.ts exists and uses test.step() for structured flow
- tests/social/promotions.spec.ts exists and validates promotional content presence
- Tipping test enforces stop-before-payment (no submitTipButton.click())
- Promotions test uses flexible selectors (no specific promo text assertions)
- All tests tagged @social (tipping also @critical)
- No networkidle, waitForTimeout, or CSS class-only selectors
- TypeScript compiles: `npm run typecheck` passes
- All 4 social tests listed: `npx playwright test --grep @social --list`
</verification>

<success_criteria>
- 2 social test spec files exist and are listed by Playwright
- Tests cover SOCIAL-03 (tipping flow with stop-before-payment) and SOCIAL-04 (promotional content display)
- Tipping test uses test.step() for multi-step flow reporting
- Tipping test stops before payment (submitTipButton.click() absent from file)
- Promotions test validates presence/structure, not specific content
- All tests tagged appropriately (@critical @social for tipping, @social for promotions)
- TypeScript compiles without errors
- Combined with Plan 03-01, all 4 SOCIAL requirements have test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/03-social-live-features/03-02-SUMMARY.md`
</output>
