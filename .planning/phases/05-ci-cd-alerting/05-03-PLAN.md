---
phase: 05-ci-cd-alerting
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - tests/smoke/navigation.spec.ts
  - tests/smoke/lobby.spec.ts
  - tests/smoke/search.spec.ts
  - tests/social/promotions.spec.ts
autonomous: true

must_haves:
  truths:
    - "Every test file has either @critical or @warning tag for severity-based alerting"
    - "CRITICAL flows (game launch, login, registration, homepage, chat, tipping, crypto) are tagged @critical"
    - "WARNING flows (navigation, lobby, search, promotions) are tagged @warning"
    - "npx playwright test --grep @critical lists all critical tests"
    - "npx playwright test --grep @warning lists all warning tests"
  artifacts:
    - path: "tests/smoke/navigation.spec.ts"
      provides: "Navigation test with @warning severity tag"
      contains: "@warning"
    - path: "tests/smoke/lobby.spec.ts"
      provides: "Lobby test with @warning severity tag"
      contains: "@warning"
    - path: "tests/smoke/search.spec.ts"
      provides: "Search test with @warning severity tag"
      contains: "@warning"
    - path: "tests/social/promotions.spec.ts"
      provides: "Promotions test with @warning severity tag"
      contains: "@warning"
  key_links:
    - from: "scripts/notify-slack.js"
      to: "tests/**/*.spec.ts"
      via: "severity categorization reads @critical/@warning tags from Playwright JSON report"
      pattern: "@critical|@warning"
---

<objective>
Add @warning severity tags to the 4 test files that currently lack severity tags (navigation, lobby, search, promotions). This ensures the alerting script (Plan 2) can properly categorize all failures as either CRITICAL or WARNING, and the `test:critical` / `test:warning` npm scripts work correctly for selective test execution.

Purpose: Without severity tags on all tests, the alerting system defaults untagged tests to WARNING (safe fallback), but explicit tagging is needed for: (1) clarity about which tests are critical vs informational, (2) correct `--grep @warning` filtering, and (3) documentation of severity classification per ALERT-03. This plan also serves as integration verification for Plans 1 and 2.

Output: 4 updated test files with @warning tags.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ci-cd-alerting/05-RESEARCH.md

# Files to modify
@tests/smoke/navigation.spec.ts
@tests/smoke/lobby.spec.ts
@tests/smoke/search.spec.ts
@tests/social/promotions.spec.ts

# Reference for tagging pattern
@tests/smoke/health-check.spec.ts (example of @critical @smoke tagging pattern)
@tests/helpers/test-config.ts (Tags.WARNING = '@warning')
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add @warning severity tags to untagged test files</name>
  <files>
    tests/smoke/navigation.spec.ts
    tests/smoke/lobby.spec.ts
    tests/smoke/search.spec.ts
    tests/social/promotions.spec.ts
  </files>
  <action>
Four test files currently lack severity tags (@critical or @warning). Per ALERT-03, these are WARNING-level flows (non-critical features). Add @warning tag to each test's title string.

The existing tagging pattern uses inline tags in the test title string (e.g., `'homepage loads successfully @critical @smoke'`). Follow this exact pattern.

**1. `tests/smoke/navigation.spec.ts`:**

Change the test title from:
```
'top navigation reaches at least 2 major sections @smoke'
```
To:
```
'top navigation reaches at least 2 major sections @warning @smoke'
```

Insert `@warning` before `@smoke` to maintain the pattern of severity tag first, category tag second (consistent with other tests like `@critical @smoke`, `@critical @auth`, etc.).

**2. `tests/smoke/lobby.spec.ts`:**

Change the test title from:
```
'lobby page displays game categories and game grid @smoke'
```
To:
```
'lobby page displays game categories and game grid @warning @smoke'
```

**3. `tests/smoke/search.spec.ts`:**

Change the test title from:
```
'search returns results and user can open a game @smoke'
```
To:
```
'search returns results and user can open a game @warning @smoke'
```

**4. `tests/social/promotions.spec.ts`:**

Change the test title from:
```
'"Latest and Greatest" promotional messages display @social'
```
To:
```
'"Latest and Greatest" promotional messages display @warning @social'
```

Each change is a single string edit in the `test()` function call's first argument. Do NOT change any test logic, assertions, imports, or comments.

**Severity classification rationale (per ALERT-03):**
- These 4 tests cover non-critical features: navigation (browsing), lobby display (presentation), search (discovery), promotions (marketing content)
- They are informational — failure indicates degraded experience but not a broken core flow
- CRITICAL tests cover revenue-impacting flows: game launches, login, registration, crypto purchases, chat connectivity, tipping
  </action>
  <verify>
    Run `npx tsc --noEmit` — TypeScript compiles without errors.
    Run `npx playwright test --grep @warning --list` — should list exactly 4 tests (navigation, lobby, search, promotions).
    Run `npx playwright test --grep @critical --list` — should list 13 tests (unchanged from before).
    Total tests: `npx playwright test --list` — should list 17 tests total.
    Confirm 4 + 13 = 17 (all tests have a severity tag).
    Grep for test titles without @critical or @warning: should return zero results (every test has a severity tag).
  </verify>
  <done>
    All 17 test files have explicit severity tags. 13 tests tagged @critical (homepage, health-check, login, session-persistence, registration, slot-launch, table-launch, live-dealer-launch, chat-connection, chat-messages, tipping-flow, 2x crypto). 4 tests tagged @warning (navigation, lobby, search, promotions). `npx playwright test --grep @critical` and `--grep @warning` correctly filter by severity.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify end-to-end integration of CI/CD pipeline components</name>
  <files></files>
  <action>
This is a verification-only task — no files are created or modified. It validates that Plans 1, 2, and 3 work together as a coherent CI/CD pipeline.

Run the following verification checks:

**1. Playwright config produces JSON output:**
```bash
npx playwright test --grep @critical --list
```
Confirm test list is non-empty.

**2. Script syntax check:**
```bash
node --check scripts/notify-slack.js
```
Confirm no syntax errors.

**3. TypeScript compilation:**
```bash
npx tsc --noEmit
```
Confirm no type errors.

**4. Severity tag coverage audit:**
```bash
# Count tests per severity
npx playwright test --grep @critical --list 2>&1 | grep -c "test"
npx playwright test --grep @warning --list 2>&1 | grep -c "test"
```
Confirm @critical count = 13, @warning count = 4, total = 17.

**5. File existence checks:**
Verify these files exist:
- `.github/workflows/playwright.yml`
- `scripts/notify-slack.js`
- `test-results/` directory is gitignored
- `.state/` directory is gitignored

**6. Cross-file reference integrity:**
- Workflow references `scripts/notify-slack.js` — script exists
- Workflow runs `npx playwright test` — playwright.config.ts has JSON reporter outputting to `test-results/results.json`
- Script reads from `test-results/results.json` — matches playwright.config.ts output path
- Script writes to `.state/failure-state.json` — `.state/` in .gitignore
- Script writes to `test-results/summary.json` — `test-results/` in .gitignore
- .env.example documents SLACK_WEBHOOK_URL — workflow passes it as secret

**7. Grep for anti-patterns:**
```bash
# No hardcoded webhook URLs
grep -r "hooks.slack.com" scripts/ .github/ || echo "OK: no hardcoded webhooks"

# No networkidle in any test
grep -r "networkidle" tests/ || echo "OK: no networkidle"

# No waitForTimeout in any test
grep -r "waitForTimeout" tests/ || echo "OK: no waitForTimeout"
```

If any check fails, fix the issue in the relevant file before marking this task done.
  </action>
  <verify>
    All 7 verification categories pass. Specifically:
    - npx tsc --noEmit exits 0
    - node --check scripts/notify-slack.js exits 0
    - All 17 tests have severity tags
    - All cross-file references resolve correctly
    - No anti-patterns found
  </verify>
  <done>
    End-to-end integration verified: GitHub Actions workflow triggers Playwright tests, JSON reporter outputs results, notification script parses results and sends severity-based Slack alerts with consecutive failure tracking, all tests have explicit severity tags for correct categorization.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `node --check scripts/notify-slack.js` passes
3. `npx playwright test --grep @warning --list` shows 4 tests
4. `npx playwright test --grep @critical --list` shows 13 tests
5. `npx playwright test --list` shows 17 total tests (4 + 13)
6. No test title string lacks both @critical and @warning
7. `.github/workflows/playwright.yml` references `scripts/notify-slack.js` which exists
8. Playwright JSON reporter output path matches script's input path
9. No hardcoded webhook URLs in scripts or workflow
10. No anti-patterns (networkidle, waitForTimeout) in test files
</verification>

<success_criteria>
- ALERT-03 (complete): All tests explicitly tagged — CRITICAL flows (game launch, login, registration, homepage, chat, crypto, tipping) use @critical; WARNING flows (navigation, lobby, search, promotions) use @warning
- Integration verified: Workflow -> Playwright (JSON output) -> Notification script (parse + track + alert) -> Slack (Block Kit message) pipeline is end-to-end consistent
- Selective execution: `npx playwright test --grep @critical` and `--grep @warning` correctly filter tests by severity
</success_criteria>

<output>
After completion, create `.planning/phases/05-ci-cd-alerting/05-03-SUMMARY.md`
</output>
