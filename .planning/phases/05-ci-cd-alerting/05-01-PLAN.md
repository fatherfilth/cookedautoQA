---
phase: 05-ci-cd-alerting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/playwright.yml
  - playwright.config.ts
  - .gitignore
  - package.json
autonomous: true

must_haves:
  truths:
    - "GitHub Actions workflow runs tests on a 30-minute cron schedule"
    - "GitHub Actions workflow runs tests on push to main branch"
    - "GitHub Actions workflow runs tests on manual workflow_dispatch trigger"
    - "Playwright HTML report and JSON results are uploaded as GitHub Actions artifacts"
    - "Node modules and Playwright browsers are cached for faster CI runs"
    - "Concurrency control prevents overlapping scheduled runs"
    - "Reasonable timeouts are set at workflow level (15 min) and test level (60s existing)"
  artifacts:
    - path: ".github/workflows/playwright.yml"
      provides: "GitHub Actions workflow with schedule, push, workflow_dispatch triggers, caching, artifact upload, and alerting step"
      min_lines: 60
    - path: "playwright.config.ts"
      provides: "Updated reporter config with JSON reporter alongside existing HTML and list reporters"
      contains: "json"
    - path: ".gitignore"
      provides: "Updated gitignore with .state/ directory for failure tracking state"
      contains: ".state/"
    - path: "package.json"
      provides: "Updated package.json with packageManager field for setup-node caching and test:ci script"
      contains: "packageManager"
  key_links:
    - from: ".github/workflows/playwright.yml"
      to: "playwright.config.ts"
      via: "npx playwright test reads reporter config"
      pattern: "npx playwright test"
    - from: ".github/workflows/playwright.yml"
      to: "scripts/notify-slack.js"
      via: "post-test alert step runs notification script"
      pattern: "node scripts/notify-slack.js"
    - from: ".github/workflows/playwright.yml"
      to: "test-results/"
      via: "upload-artifact uploads test results directory"
      pattern: "test-results"
---

<objective>
Create the GitHub Actions CI/CD workflow that runs Playwright tests on schedule (every 30 minutes), on push to main, and via manual trigger. Configure caching, artifact uploads, concurrency control, and timeouts. Update Playwright config to emit JSON results for downstream alerting scripts.

Purpose: This is the CI pipeline backbone. Without it, tests only run locally. The workflow automates execution, captures artifacts on every run, and provides the hook for alerting scripts (Plan 2) to parse results and notify Slack.

Output: `.github/workflows/playwright.yml` workflow file, updated `playwright.config.ts` with JSON reporter, updated `.gitignore` and `package.json`.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ci-cd-alerting/05-RESEARCH.md

# Existing files to modify
@playwright.config.ts
@package.json
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Playwright config with JSON reporter and project supporting files</name>
  <files>
    playwright.config.ts
    .gitignore
    package.json
  </files>
  <action>
**1. Update `playwright.config.ts` — Add JSON reporter:**

Add the JSON reporter to the existing reporter array. The JSON reporter outputs structured test results that the alerting script (Plan 2) will parse. Keep existing `html` and `list` reporters.

Change the reporter array from:
```typescript
reporter: [
  ['html', { open: 'never' }],
  ['list'],
],
```
To:
```typescript
reporter: [
  ['html', { open: 'never' }],
  ['list'],
  ['json', { outputFile: 'test-results/results.json' }],
],
```

The `test-results/` directory is already in `.gitignore`. The JSON file lands alongside Playwright's default test artifacts (screenshots, traces, videos) which are also written to `test-results/`.

**2. Update `.gitignore` — Add `.state/` directory:**

Append `.state/` to the existing `.gitignore`. This directory will hold consecutive failure tracking state (Plan 2). It must not be committed to the repo — it's runtime state managed by the CI workflow.

Add this line after the existing entries:
```
.state/
```

**3. Update `package.json` — Add `packageManager` field and `test:ci` script:**

Add a `packageManager` field to enable setup-node@v6 auto-caching. This tells GitHub Actions which package manager to use for cache key generation.

Add after the `"type": "module"` line:
```json
"packageManager": "npm@10.9.2",
```

Also add a `test:ci` script that mirrors what the workflow will run (useful for local CI simulation):
```json
"test:ci": "playwright test --grep @critical"
```

Add it after the existing `test:warning` script in the scripts section.

Do NOT change any existing scripts or dependencies.
  </action>
  <verify>
    Run `npx tsc --noEmit` — TypeScript compiles without errors (playwright.config.ts still valid).
    Confirm `playwright.config.ts` reporter array has exactly 3 entries: html, list, json.
    Confirm `.gitignore` contains `.state/` line.
    Confirm `package.json` has `packageManager` field and `test:ci` script.
    Confirm `package.json` is valid JSON: `node -e "require('./package.json')"` exits 0.
  </verify>
  <done>
    Playwright config emits JSON results to test-results/results.json alongside HTML report. .gitignore excludes .state/ directory. package.json has packageManager field for CI caching and test:ci script for local CI simulation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions workflow with triggers, caching, artifacts, and alert hook</name>
  <files>
    .github/workflows/playwright.yml
  </files>
  <action>
Create `.github/workflows/playwright.yml` with the following structure. This is the core CI pipeline.

**Directory creation:** Create `.github/workflows/` directory first (it doesn't exist yet).

**Workflow file content:**

```yaml
name: Playwright Monitoring

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes (UTC)
  push:
    branches: [main]
  workflow_dispatch:  # Manual trigger from GitHub UI

concurrency:
  group: playwright-monitoring
  cancel-in-progress: true

jobs:
  test:
    timeout-minutes: 15
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'

      - name: Install Playwright system dependencies
        run: npx playwright install-deps chromium
        if: steps.playwright-cache.outputs.cache-hit == 'true'

      - name: Run Playwright tests
        run: npx playwright test
        env:
          CI: true
          BASE_URL: ${{ secrets.BASE_URL || 'https://cooked.com' }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload test results (traces, screenshots, videos, JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 7

      - name: Send Slack alert on failure
        if: failure()
        run: node scripts/notify-slack.js
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
```

**Key design decisions explained (include as YAML comments where helpful):**

1. **Concurrency group `playwright-monitoring`** with `cancel-in-progress: true` — prevents overlapping scheduled runs (CICD-06). If a 30-min run hasn't finished when the next fires, the old one is cancelled.

2. **`timeout-minutes: 15`** — workflow-level timeout (CICD-07). Prevents runaway jobs from consuming excessive CI minutes. Current test suite should complete well within this.

3. **Two upload-artifact steps** — HTML report gets 30-day retention (for historical reference), test-results (traces, screenshots, videos, JSON) gets 7-day retention (larger files, less historical value) (CICD-04, REPORT-02).

4. **Playwright browser caching** — Cache key based on `package-lock.json` hash. On cache hit, skip full `playwright install` (which downloads browsers) and only run `install-deps` (installs system libraries). On cache miss, do full install. This saves ~30-45 seconds per cached run (CICD-05).

5. **setup-node with `cache: 'npm'`** — Auto-caches node_modules based on package-lock.json (CICD-05). Requires `packageManager` field in package.json (set in Task 1).

6. **`if: failure()` on alert step** — Only runs the Slack notification script when tests fail. The script itself (created in Plan 2) handles severity categorization and consecutive failure tracking.

7. **`if: always()` on artifact uploads** — Uploads artifacts even when tests fail (which is when artifacts are most needed for debugging).

8. **`npx playwright test` without `--grep`** — Runs ALL tests (not just @critical) by default. The research noted a concern about free tier minutes (4320 min/month with 30-min schedule). However, the full suite should run in ~2-3 minutes, and we can adjust to `--grep @critical` later if minutes become a concern. Running full suite on all triggers gives maximum coverage.

9. **Secrets for credentials** — BASE_URL, TEST_USER_EMAIL, TEST_USER_PASSWORD passed via GitHub Secrets. SLACK_WEBHOOK_URL only needed in failure step.

Important: The `node scripts/notify-slack.js` step references the script created in Plan 2. If this workflow runs before Plan 2 is complete, the failure step will error (script doesn't exist yet). This is acceptable — the test execution and artifact upload steps work independently. Plan 3 will verify full integration.
  </action>
  <verify>
    Confirm `.github/workflows/playwright.yml` exists and is valid YAML: `node -e "const yaml = require('yaml'); yaml.parse(require('fs').readFileSync('.github/workflows/playwright.yml', 'utf-8'))"` — if yaml package not available, just visually verify YAML indentation is consistent.
    Confirm workflow has all three triggers: schedule (cron), push (branches: [main]), workflow_dispatch.
    Confirm concurrency group is set with cancel-in-progress: true.
    Confirm timeout-minutes is set on the job.
    Confirm two upload-artifact steps exist (playwright-report and test-results).
    Confirm cache step for Playwright browsers exists with conditional install.
    Confirm setup-node has cache: 'npm'.
    Confirm alert step has `if: failure()` condition.
    Confirm all secrets are referenced via `${{ secrets.* }}` syntax (not hardcoded).
  </verify>
  <done>
    GitHub Actions workflow exists at `.github/workflows/playwright.yml` with: cron schedule every 30 minutes (CICD-01), push to main trigger (CICD-02), workflow_dispatch trigger (CICD-03), Playwright report and test results uploaded as artifacts (CICD-04, REPORT-02), npm and Playwright browser caching (CICD-05), concurrency control (CICD-06), 15-minute timeout (CICD-07), and Slack alert hook on failure.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `.github/workflows/playwright.yml` exists with valid YAML structure
3. Workflow has three triggers: schedule (*/30 * * * *), push (main), workflow_dispatch
4. Concurrency group `playwright-monitoring` with `cancel-in-progress: true`
5. Job timeout-minutes set to 15
6. Two artifact upload steps with different retention periods (30 days report, 7 days results)
7. Playwright browser cache with conditional install logic
8. setup-node@v6 with `cache: 'npm'`
9. playwright.config.ts has JSON reporter outputting to test-results/results.json
10. .gitignore includes .state/ directory
11. package.json has packageManager field and test:ci script
12. All secrets use `${{ secrets.* }}` syntax
</verification>

<success_criteria>
- CICD-01: Workflow has `schedule: cron: '*/30 * * * *'` trigger
- CICD-02: Workflow has `push: branches: [main]` trigger
- CICD-03: Workflow has `workflow_dispatch` trigger
- CICD-04: Two upload-artifact steps capture playwright-report/ and test-results/ (HTML report, traces, screenshots, videos, JSON results)
- CICD-05: setup-node caches npm, Playwright browsers cached via actions/cache@v4
- CICD-06: Concurrency group prevents overlapping runs
- CICD-07: Job has timeout-minutes: 15
- REPORT-02: Playwright HTML report generated (existing html reporter) and uploaded as artifact
</success_criteria>

<output>
After completion, create `.planning/phases/05-ci-cd-alerting/05-01-SUMMARY.md`
</output>
