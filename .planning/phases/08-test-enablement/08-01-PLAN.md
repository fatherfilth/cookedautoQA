---
phase: 08-test-enablement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/auth/login.spec.ts
  - tests/auth/session-persistence.spec.ts
autonomous: true
must_haves:
  truths:
    - "Login test passes without skip directive — verifies login form UI is accessible and session is active"
    - "Session persistence test passes — authenticated session survives navigation to lobby and back to homepage"
    - "Neither test references TEST_USER_EMAIL or TEST_USER_PASSWORD env vars"
  artifacts:
    - path: "tests/auth/login.spec.ts"
      provides: "Auth login verification using storageState"
      contains: "storageState"
    - path: "tests/auth/session-persistence.spec.ts"
      provides: "Session persistence verification using storageState"
      contains: "storageState"
  key_links:
    - from: "tests/auth/login.spec.ts"
      to: ".auth/user.json"
      via: "Playwright storageState loaded by chromium project config"
      pattern: "auth indicator.*visible"
    - from: "tests/auth/session-persistence.spec.ts"
      to: ".auth/user.json"
      via: "Playwright storageState loaded by chromium project config"
      pattern: "storageState|cookie"
---

<objective>
Rewrite auth tests (login, session persistence) to leverage storageState from Phase 7 setup project instead of manual env var login.

Purpose: The login and session-persistence tests currently hard-skip when `TEST_USER_EMAIL` / `TEST_USER_PASSWORD` env vars are missing. Phase 7 introduced a setup project that auto-registers and saves storageState to `.auth/user.json`, which the chromium project loads automatically. These tests must be rewritten to verify auth works via storageState rather than re-logging in.

Output: Two rewritten spec files that pass with authenticated storageState sessions, zero skip directives.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-auth-foundation/07-01-SUMMARY.md
@tests/auth/auth.setup.ts
@tests/auth/login.spec.ts
@tests/auth/session-persistence.spec.ts
@tests/pages/LoginPage.ts
@playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite login test to verify storageState auth instead of manual login</name>
  <files>tests/auth/login.spec.ts</files>
  <action>
Rewrite `tests/auth/login.spec.ts` to verify that the authenticated session from storageState works correctly, rather than performing a manual login flow.

**Remove entirely:**
- The `process.env.TEST_USER_EMAIL` / `TEST_USER_PASSWORD` check and `test.skip()` block (lines 6-11)
- The manual login flow (open dialog, fill credentials, submit)

**New test logic — "user is authenticated via storageState":**
1. Navigate to homepage (`page.goto('/')`)
2. Assert auth indicator is visible (reuse the same pattern from auth.setup.ts):
   ```
   page.getByRole('button', { name: /log out|sign out|account|profile/i })
     .or(page.getByText(/welcome|account|profile/i))
     .or(page.locator('[class*="avatar"], [class*="user"], [class*="profile"]').first())
   ```
   Use `toBeVisible({ timeout: 15_000 })` to allow for client-side hydration.
3. Verify login dialog can still open and shows the correct UI structure:
   - Click Login button (may show "Account" or similar when already logged in — use the LoginPage.loginButton locator)
   - If dialog opens, verify `authDialog` is visible and has email/password fields
   - If dialog does NOT open (because user is already logged in), that's also a valid outcome — assert the auth indicator remains visible
4. Keep the `@critical @auth` tags on the test

**Keep the LoginPage import** — it provides the locators for verifying dialog structure. But the test should NOT call `loginPage.login()`.

**Test name:** Change to `'authenticated session is active after storageState load @critical @auth'`
  </action>
  <verify>Run `npx tsc --noEmit` to confirm TypeScript compiles. Run `npx playwright test --list` and confirm login.spec.ts appears without skip indicators.</verify>
  <done>login.spec.ts has no test.skip() directives, no env var checks, verifies auth via storageState indicator, compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite session persistence test to verify storageState survives navigation</name>
  <files>tests/auth/session-persistence.spec.ts</files>
  <action>
Rewrite `tests/auth/session-persistence.spec.ts` to verify that the authenticated session loaded from storageState persists across page navigation, rather than performing a manual login first.

**Remove entirely:**
- The `process.env.TEST_USER_EMAIL` / `TEST_USER_PASSWORD` check and `test.skip()` block (lines 6-12)
- The manual login flow via LoginPage (lines 14-26)

**New test logic — "storageState session persists across navigation":**
1. Navigate to homepage (`page.goto('/')`)
2. Assert auth indicator is visible (same pattern as Task 1) with `toBeVisible({ timeout: 15_000 })`
3. Capture storageState: `const stateAfterLoad = await context.storageState()`
4. Verify at least one session-related cookie exists:
   ```typescript
   const sessionCookie = stateAfterLoad.cookies.find(
     c => c.name.includes('session') || c.name.includes('token') || c.name.includes('auth')
   );
   expect(sessionCookie).toBeDefined();
   ```
5. Navigate to lobby: `await lobbyPage.open()` and verify lobby loaded (`lobbyPage.gameGrid.or(page.getByRole('heading').first())`).toBeVisible()
6. Navigate back to homepage: `page.goto('/')`
7. Assert auth indicator STILL visible (same pattern, `toBeVisible({ timeout: 10_000 })`)
8. Verify session cookie persisted:
   ```typescript
   const stateAfterNav = await context.storageState();
   const persistedCookie = stateAfterNav.cookies.find(c => c.name === sessionCookie!.name);
   expect(persistedCookie).toBeDefined();
   ```

**Keep imports:** `LoginPage` can be removed (no longer used). Keep `LobbyPage` for navigation test. Keep `{ test, expect }` from `@playwright/test`.

**Test name:** Change to `'authenticated session persists across page navigation @critical @auth'`

**Keep the `context` fixture** in the test signature (`{ page, context }`) — needed for storageState inspection.
  </action>
  <verify>Run `npx tsc --noEmit` to confirm TypeScript compiles. Run `npx playwright test --list` and confirm session-persistence.spec.ts appears without skip indicators.</verify>
  <done>session-persistence.spec.ts has no test.skip() directives, no env var checks, no manual login, verifies storageState persistence across navigation, compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — both files compile cleanly
2. `npx playwright test --list` — both tests listed under chromium project, no skip indicators
3. Neither file contains `process.env.TEST_USER_EMAIL` or `process.env.TEST_USER_PASSWORD`
4. Neither file contains `test.skip(`
5. Both files reference auth indicator pattern (logout/account/avatar)
</verification>

<success_criteria>
- login.spec.ts verifies authenticated session from storageState (no manual login, no env var skip)
- session-persistence.spec.ts verifies session survives navigation (no manual login, no env var skip)
- Both files compile with TypeScript
- Both tests appear in `playwright test --list` under chromium project
</success_criteria>

<output>
After completion, create `.planning/phases/08-test-enablement/08-01-SUMMARY.md`
</output>
