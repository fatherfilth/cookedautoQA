---
phase: 11-test-result-history
plan: 01
subsystem: test-infrastructure
tags: [ci, monitoring, git-history, automation]
dependency_graph:
  requires: [notify-slack.js (generates summary.json)]
  provides: [automated result history commits, timestamped JSON files in results-history/]
  affects: [CI workflow, git repository history]
tech_stack:
  added: [results-history/ directory for versioned test results]
  patterns: [git automation via github-actions bot, graceful failure handling]
key_files:
  created:
    - scripts/commit-results.js
    - results-history/.gitkeep
  modified:
    - .github/workflows/playwright.yml
decisions:
  - decision: "Use ISO timestamp with hyphens (YYYY-MM-DDTHH-MM-SSZ) for filenames"
    rationale: "Safe for all filesystems (Windows/Unix), human-readable, sortable chronologically"
  - decision: "Run notify-slack.js on always() instead of failure()"
    rationale: "Ensures summary.json is generated on both passing and failing runs, enabling complete history"
  - decision: "Exit 0 on missing summary.json and push failures"
    rationale: "Prevents commit-results script from breaking CI pipeline on edge cases or race conditions"
  - decision: "Use github-actions[bot] as commit author"
    rationale: "Standard GitHub Actions bot identity for automated commits"
metrics:
  duration: 120s
  tasks: 2
  files_created: 2
  files_modified: 1
  commits: 2
  completed: 2026-02-16
---

# Phase 11 Plan 01: Test Result History Summary

**One-liner:** Automated CI commits of timestamped test result summaries to results-history/ directory, creating permanent git-tracked test health history.

## What Was Built

Created a system that commits test result summaries to the repository after each CI run, enabling long-term trend analysis without relying on ephemeral GitHub Actions artifacts (which expire after 7-30 days).

**Key components:**

1. **scripts/commit-results.js** — ESM script that:
   - Reads `test-results/summary.json` (generated by notify-slack.js)
   - Copies content to `results-history/{timestamp}.json` with ISO timestamp format
   - Commits and pushes using github-actions[bot] identity
   - Gracefully handles missing summary files and push failures (exits 0)

2. **results-history/ directory** — Git-tracked directory with `.gitkeep` for storing timestamped result files. Each CI run creates a new JSON file like `2026-02-16T14-30-00Z.json`.

3. **Updated CI workflow** — Modified `.github/workflows/playwright.yml`:
   - Added `permissions: contents: write` for git push capability
   - Changed notify-slack step from `if: failure()` to `if: always()` (generates summary.json on all runs)
   - Added new "Commit test results to history" step with `if: always()` running commit-results.js

**Flow:**
```
Tests run → notify-slack.js generates summary.json (on every run) →
commit-results.js copies to results-history/{timestamp}.json →
git commit + push → permanent record in repo history
```

## Implementation Details

### scripts/commit-results.js

ESM module structure matching notify-slack.js conventions:
- Section 1: Constants (SUMMARY_FILE, RESULTS_DIR)
- Section 2: Git configuration (configureGit function)
- Section 3: Create timestamped result file (formatTimestamp, copySummaryToHistory)
- Section 4: Commit and push (hasStagedChanges, commitAndPush)
- Section 5: Main function with error handling

**Timestamp format:** `YYYY-MM-DDTHH-MM-SSZ` (ISO 8601 with hyphens replacing colons for filesystem safety)

**Commit message format:** `results: {passed}/{total} passed ({timestamp})`
- Example: `results: 12/15 passed (2026-02-16T20-30-00Z)`

**Error handling:**
- Missing summary.json → logs warning, exits 0
- No staged changes (duplicate file) → logs message, exits 0
- Push failure (concurrent push/network) → logs warning, exits 0
- Never fails CI pipeline

### Workflow Changes

Changed notify-slack step condition:
```yaml
# BEFORE
- name: Send Slack alert on failure
  if: failure()
  run: node scripts/notify-slack.js

# AFTER
- name: Send Slack alert on failure
  if: always()
  run: node scripts/notify-slack.js
```

**Rationale:** notify-slack.js writes summary.json BEFORE checking for failures (line 392 in notify-slack.js). Running on `always()` ensures summary is generated on both pass and fail. The Slack alert logic inside the script still only sends alerts when thresholds are met.

Added new step:
```yaml
- name: Commit test results to history
  if: always()
  run: node scripts/commit-results.js
```

## Deviations from Plan

None — plan executed exactly as written.

## Verification Results

All verification criteria passed:

1. ✅ `scripts/commit-results.js` exists and is valid ESM JavaScript
2. ✅ `results-history/.gitkeep` exists and directory is tracked
3. ✅ Script reads from `test-results/summary.json` path
4. ✅ Script writes to `results-history/{timestamp}.json` format
5. ✅ Script uses git commands to commit and push
6. ✅ Script exits 0 on missing summary (graceful degradation)
7. ✅ Script exits 0 on push failure (doesn't break CI)
8. ✅ `.github/workflows/playwright.yml` has `permissions: contents: write`
9. ✅ "Send Slack alert on failure" step now has `if: always()`
10. ✅ New "Commit test results to history" step exists with `if: always()`
11. ✅ Step ordering correct: tests → artifacts → slack/summary → commit results
12. ✅ TypeScript type-check passes (no regressions)

## Success Criteria Met

- ✅ JSON summary report is committed to results-history/ after each CI test run
- ✅ Timestamped filenames enable browsing history in git (e.g., `results-history/2026-02-16T14-30-00Z.json`)
- ✅ Commit message includes pass/total count for quick scanning in git log
- ✅ Script gracefully handles missing summary.json and push failures (never breaks CI)
- ✅ Workflow runs commit logic on both passing and failing test runs

## Files Created

**scripts/commit-results.js**
- ESM module for automated result commits
- 154 lines, 5 sections following project conventions
- Reads summary.json, writes timestamped copy, commits via git CLI

**results-history/.gitkeep**
- Empty file to track results-history/ directory in git
- Ensures directory exists for script to write into

## Files Modified

**.github/workflows/playwright.yml**
- Added `permissions: contents: write` (line 18-19)
- Changed notify-slack `if: failure()` → `if: always()` (line 74)
- Added "Commit test results to history" step (lines 83-85)

## Commits

| Hash    | Message                                                    | Files |
| ------- | ---------------------------------------------------------- | ----- |
| 9e3b354 | feat(11-01): create commit-results script and results-history directory | scripts/commit-results.js, results-history/.gitkeep |
| 27a850e | feat(11-01): add commit-results step to CI workflow        | .github/workflows/playwright.yml |

## Impact

**Before:** Test results only available as GitHub Actions artifacts (expire after 7-30 days). No long-term trend visibility.

**After:** Every CI run creates a permanent JSON record in the repo. Results browsable via git history indefinitely. Enables:
- Long-term trend analysis (weekly/monthly pass rates)
- Historical debugging ("when did Test X start failing?")
- Compliance/audit trails for test coverage
- Offline analysis (clone repo, analyze results-history/*.json)

**Git history example:**
```
27a850e feat(11-01): add commit-results step to CI workflow
9e3b354 feat(11-01): create commit-results script and results-history directory
<future> results: 15/15 passed (2026-02-16T21-00-00Z)
<future> results: 14/15 passed (2026-02-16T21-30-00Z)
<future> results: 15/15 passed (2026-02-16T22-00-00Z)
```

Each result commit links to the CI run via runUrl in the JSON file.

## Next Steps

Phase 11 is designed to have 1 plan. This plan is complete.

Next phases in roadmap:
- Phase 12: Screenshot diffing tests (visual regression detection)
- Phase 13+: Additional monitoring/observability features

## Self-Check

Verifying all claimed artifacts exist and commits are valid.

**Files:**
- FOUND: scripts/commit-results.js
- FOUND: results-history/.gitkeep

**Commits:**
- FOUND: 9e3b354 (feat(11-01): create commit-results script and results-history directory)
- FOUND: 27a850e (feat(11-01): add commit-results step to CI workflow)

**Result:** PASSED

All claimed files exist and all commits are present in git history.
