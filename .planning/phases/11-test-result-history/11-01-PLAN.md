---
phase: 11-test-result-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/commit-results.js
  - .github/workflows/playwright.yml
  - results-history/.gitkeep
autonomous: true
must_haves:
  truths:
    - "JSON summary report is committed to repo after each CI test run"
    - "Results are browsable as timestamped files in git history"
    - "Commit logic runs automatically in CI without manual intervention"
    - "Git history shows progression of test results over time"
  artifacts:
    - path: "scripts/commit-results.js"
      provides: "Script that copies summary.json to results-history/ with timestamp filename and commits"
    - path: ".github/workflows/playwright.yml"
      provides: "CI workflow with commit-results step after test completion"
    - path: "results-history/.gitkeep"
      provides: "Tracked directory for result history files"
  key_links:
    - from: ".github/workflows/playwright.yml"
      to: "scripts/commit-results.js"
      via: "CI step runs node scripts/commit-results.js after tests"
      pattern: "node scripts/commit-results\\.js"
    - from: "scripts/commit-results.js"
      to: "test-results/summary.json"
      via: "reads summary.json generated by notify-slack.js"
      pattern: "test-results/summary\\.json"
    - from: "scripts/commit-results.js"
      to: "results-history/"
      via: "writes timestamped JSON file and git commits"
      pattern: "results-history/"
---

<objective>
Commit test result summaries to the repository after each CI run, creating a browsable history of test results over time.

Purpose: Enable trend analysis and historical visibility into test health without relying on ephemeral GitHub Actions artifacts (which expire after 7-30 days). Every CI run leaves a permanent JSON record in the repo.

Output: A `scripts/commit-results.js` script, an updated CI workflow, and a `results-history/` directory that accumulates timestamped result files.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@scripts/notify-slack.js
@.github/workflows/playwright.yml
@playwright.config.ts
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create commit-results script and results-history directory</name>
  <files>scripts/commit-results.js, results-history/.gitkeep</files>
  <action>
Create `results-history/.gitkeep` (empty file) so the directory is tracked in git.

Create `scripts/commit-results.js` (ESM module, matching project convention from notify-slack.js) that:

1. Reads `test-results/summary.json` (generated by notify-slack.js which already runs in the workflow). If the file does not exist, log a warning and exit 0 (don't fail CI).

2. Copies the summary JSON content to `results-history/{timestamp}.json` where timestamp is ISO-like format safe for filenames: `YYYY-MM-DDTHH-MM-SSZ` (replace colons with hyphens). Example: `results-history/2026-02-16T14-30-00Z.json`.

3. Runs git commands to commit the new file:
   - `git config user.name "github-actions[bot]"`
   - `git config user.email "github-actions[bot]@users.noreply.github.com"`
   - `git add results-history/`
   - Check if there are staged changes (via `git diff --cached --quiet`). If no changes, log "No new results to commit" and exit 0.
   - `git commit -m "results: {passed}/{total} passed ({timestamp})"` where passed/total come from the summary JSON
   - `git push`

4. Uses `child_process.execSync` for git commands (Node.js built-in, no extra dependencies needed). Wraps push in try/catch — if push fails (e.g., concurrent push), log warning but exit 0 (don't fail CI).

5. The script should log each step clearly for CI visibility.

Important: The script runs AFTER notify-slack.js in the workflow, so summary.json will already exist. The `if: always()` condition ensures it runs even when tests fail, so we capture failure results too.
  </action>
  <verify>
    - File `scripts/commit-results.js` exists and is valid ESM JavaScript
    - File `results-history/.gitkeep` exists
    - Script reads from `test-results/summary.json` path
    - Script writes to `results-history/{timestamp}.json`
    - Script uses git commands to commit and push
    - Script exits 0 on missing summary (graceful degradation)
    - Script exits 0 on push failure (doesn't break CI)
  </verify>
  <done>Script can read a summary.json, copy it to a timestamped file in results-history/, and commit+push via git CLI</done>
</task>

<task type="auto">
  <name>Task 2: Add commit-results step to CI workflow</name>
  <files>.github/workflows/playwright.yml</files>
  <action>
Add two new steps to `.github/workflows/playwright.yml` after the "Send Slack alert on failure" step:

1. **"Generate test summary"** step:
   - `if: always()` — runs on both pass and fail
   - `run: node scripts/notify-slack.js || true` — generates summary.json even on pass (notify-slack.js already writes summary always, but the current workflow only runs it `if: failure()`)
   - Wait — actually, the current workflow runs notify-slack.js only on failure (`if: failure()`). The summary.json is generated inside notify-slack.js via `writeSummary()` which runs before the failure check. But since the step only runs on failure, summary.json won't exist on passing runs.
   - Solution: Add a NEW step "Generate test summary" with `if: always()` that runs `node scripts/notify-slack.js` but set SLACK_WEBHOOK_URL only in the failure step. Actually, looking at notify-slack.js more carefully — it writes summary FIRST (line ~392), then checks for failures. If SLACK_WEBHOOK_URL is not set, it just warns and skips Slack. So running it on `always()` is safe.
   - REVISED approach: Change the existing "Send Slack alert on failure" step from `if: failure()` to `if: always()`. The script already handles the case of no failures (exits early after writing summary). Slack alert only sends if webhook URL is set AND failures exist AND threshold is met. This is the cleanest change.

2. **"Commit test results to history"** step:
   - `if: always()` — capture results on both pass and fail
   - `run: node scripts/commit-results.js`
   - `env:` section with `GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}` (for push auth — though the default token should work with the checkout action)

Also need to update the checkout step to use a token that can push, and to fetch the full history. Add to the existing "Checkout repository" step:
   - `token: ${{ secrets.GITHUB_TOKEN }}` (explicit, though it's the default)
   - The default `actions/checkout@v6` already configures git credentials for push via the token.

Actually, for `git push` to work in GitHub Actions, the workflow needs write permissions. Add at the job level:
```yaml
    permissions:
      contents: write
```

Summary of changes to `.github/workflows/playwright.yml`:
1. Add `permissions: contents: write` to the `test` job
2. Change "Send Slack alert on failure" step from `if: failure()` to `if: always()` (so summary.json is generated on every run)
3. Add new step "Commit test results to history" after Slack step with `if: always()` running `node scripts/commit-results.js`

Do NOT change any other existing steps. Keep all env vars on existing steps as-is.
  </action>
  <verify>
    - `.github/workflows/playwright.yml` has `permissions: contents: write` on the test job
    - "Send Slack alert on failure" step now has `if: always()` (not `if: failure()`)
    - New "Commit test results to history" step exists with `if: always()`
    - New step runs `node scripts/commit-results.js`
    - Step ordering is correct: tests → upload artifacts → slack/summary → commit results
  </verify>
  <done>CI workflow generates summary.json on every run (pass or fail) and commits timestamped result to results-history/</done>
</task>

</tasks>

<verification>
1. `scripts/commit-results.js` exists and follows ESM conventions matching notify-slack.js
2. `results-history/.gitkeep` exists and directory is NOT in .gitignore
3. `.github/workflows/playwright.yml` has the commit-results step with `if: always()`
4. Workflow has `permissions: contents: write` for git push
5. notify-slack.js step runs on `always()` to generate summary.json for all runs
6. TypeScript type-check passes: `npx tsc --noEmit` (script is JS, so no impact, but verify no regressions)
</verification>

<success_criteria>
- JSON summary report is committed to results-history/ after each CI test run
- Timestamped filenames enable browsing history in git (e.g., `results-history/2026-02-16T14-30-00Z.json`)
- Commit message includes pass/total count for quick scanning in git log
- Script gracefully handles missing summary.json and push failures (never breaks CI)
- Workflow runs commit logic on both passing and failing test runs
</success_criteria>

<output>
After completion, create `.planning/phases/11-test-result-history/11-01-SUMMARY.md`
</output>
