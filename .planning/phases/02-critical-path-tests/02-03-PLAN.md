---
phase: 02-critical-path-tests
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/auth/login.spec.ts
  - tests/auth/session-persistence.spec.ts
  - tests/auth/registration.spec.ts
autonomous: true

must_haves:
  truths:
    - "User can log in with email/password and reach account page showing authenticated content"
    - "Login session persists across page navigation — user remains logged in after navigating away and back"
    - "Registration flow completes step-by-step without creating a real account — form fields accept input and submit button is present but never clicked"
  artifacts:
    - path: "tests/auth/login.spec.ts"
      provides: "Login flow test with credential validation"
      contains: "@critical @auth"
    - path: "tests/auth/session-persistence.spec.ts"
      provides: "Session persistence test across navigation"
      contains: "@critical @auth"
    - path: "tests/auth/registration.spec.ts"
      provides: "Registration flow test with stop-before-submit pattern"
      contains: "@critical @auth"
  key_links:
    - from: "tests/auth/login.spec.ts"
      to: "tests/pages/LoginPage.ts"
      via: "import LoginPage"
      pattern: "import.*LoginPage"
    - from: "tests/auth/login.spec.ts"
      to: "tests/pages/AccountPage.ts"
      via: "import AccountPage for post-login verification"
      pattern: "import.*AccountPage"
    - from: "tests/auth/session-persistence.spec.ts"
      to: "tests/pages/LobbyPage.ts"
      via: "import LobbyPage for navigation target"
      pattern: "import.*LobbyPage"
    - from: "tests/auth/registration.spec.ts"
      to: "tests/pages/RegistrationPage.ts"
      via: "import RegistrationPage"
      pattern: "import.*RegistrationPage"
---

<objective>
Create authentication flow tests (AUTH-01 through AUTH-03) validating login, session persistence across navigation, and registration flow step-by-step without creating real accounts.

Purpose: Authentication is the gateway to all personalized features (account, deposits, gameplay). If login breaks, users cannot access their accounts or funds. Registration issues block new user acquisition.
Output: 3 test spec files in tests/auth/ covering login, session persistence, and registration flows.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@tests/pages/LoginPage.ts
@tests/pages/AccountPage.ts
@tests/pages/LobbyPage.ts
@tests/pages/RegistrationPage.ts
@tests/pages/BasePage.ts
@tests/helpers/test-config.ts
@.env.example
@playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create login and session persistence tests (AUTH-01, AUTH-02)</name>
  <files>tests/auth/login.spec.ts, tests/auth/session-persistence.spec.ts</files>
  <action>
Create the `tests/auth/` directory if it doesn't exist.

Create `tests/auth/login.spec.ts` for AUTH-01:
- Import `test, expect` from `@playwright/test`
- Import `LoginPage` from `../pages/LoginPage.js`
- Import `AccountPage` from `../pages/AccountPage.js`
- Single test: `'user can log in with email/password and reach account page @critical @auth'`
- Create `new LoginPage(page)` and `new AccountPage(page)`
- Open login page: `await loginPage.open()`
- Login with env credentials: `await loginPage.loginWithEnvCredentials()`
  - This reads TEST_USER_EMAIL and TEST_USER_PASSWORD from environment (already implemented in LoginPage)
  - Will throw descriptive error if env vars missing
- Wait for navigation to account page or dashboard: `await page.waitForURL('**/account**', { timeout: 15_000 }).catch(() => {})` — catch because URL pattern may differ; the key assertion is content
- Verify authenticated state — assert at least one of these is visible (use .or() to handle different site layouts):
  - `await expect(accountPage.username.or(accountPage.email).or(page.getByText(/welcome|account|profile/i))).toBeVisible({ timeout: 10_000 })`
- This validates the user reached an authenticated page with user-specific content (per research pitfall 3 — validate auth state, not just page load).

Create `tests/auth/session-persistence.spec.ts` for AUTH-02:
- Import `test, expect` from `@playwright/test`
- Import `LoginPage` from `../pages/LoginPage.js`
- Import `AccountPage` from `../pages/AccountPage.js`
- Import `LobbyPage` from `../pages/LobbyPage.js`
- Single test: `'login session persists across page navigation @critical @auth'`
- Login:
  - Create page objects: `new LoginPage(page)`, `new AccountPage(page)`, `new LobbyPage(page)`
  - `await loginPage.open()`
  - `await loginPage.loginWithEnvCredentials()`
  - Wait briefly for login to process: `await page.waitForURL('**/account**', { timeout: 15_000 }).catch(() => {})`
- Capture storage state after login:
  - `const stateAfterLogin = await context.storageState()`
  - Assert at least one session-related cookie exists: `const sessionCookie = stateAfterLogin.cookies.find(c => c.name.includes('session') || c.name.includes('token') || c.name.includes('auth')); expect(sessionCookie).toBeDefined();`
  - Add comment: `// TODO: After live site inspection, update cookie name pattern to match actual session cookie`
- Navigate away: `await lobbyPage.open()`
- Assert lobby page loaded (not just URL): `await expect(lobbyPage.gameGrid.or(page.getByRole('heading').first())).toBeVisible()`
- Navigate back to account: `await accountPage.open()`
- Assert session persists — user still logged in:
  - `await expect(accountPage.logoutButton.or(accountPage.username).or(page.getByText(/welcome|account|log out/i))).toBeVisible({ timeout: 10_000 })`
- Verify storage state still has session cookie:
  - `const stateAfterNav = await context.storageState()`
  - `const persistedCookie = stateAfterNav.cookies.find(c => c.name === sessionCookie!.name); expect(persistedCookie).toBeDefined();`

Both tests require TEST_USER_EMAIL and TEST_USER_PASSWORD environment variables. The test function signatures must include `context` parameter for session-persistence test: `async ({ page, context })`.
ESM imports with .js extensions throughout.
  </action>
  <verify>
Run `npx playwright test tests/auth/login.spec.ts --list` and `npx playwright test tests/auth/session-persistence.spec.ts --list` — both tests listed.
Run `npm run typecheck` — no TypeScript errors.
Run `npx playwright test --grep @auth --list` — both auth tests appear.
  </verify>
  <done>
login.spec.ts: Test listed, imports LoginPage and AccountPage, logs in with env credentials, asserts authenticated content visible, tagged @critical @auth.
session-persistence.spec.ts: Test listed, logs in, captures storageState, navigates away and back, asserts session cookie persists and authenticated content still visible, tagged @critical @auth.
TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create registration flow test (AUTH-03)</name>
  <files>tests/auth/registration.spec.ts</files>
  <action>
Create `tests/auth/registration.spec.ts` for AUTH-03:
- Import `test, expect` from `@playwright/test`
- Import `RegistrationPage` from `../pages/RegistrationPage.js`
- Single test: `'registration flow completes step-by-step without creating account @critical @auth'`
- Create `new RegistrationPage(page)`
- Open registration page: `await registrationPage.open()`
- Generate unique test data: `const testEmail = \`test-monitor-\${Date.now()}@example.com\``
- Fill form using RegistrationPage.fillForm() — this already implements stop-before-payment pattern:
  ```
  await registrationPage.fillForm({
    email: testEmail,
    password: 'SecureTestPass123!',
    username: 'test-monitor',
  });
  ```
- Verify form fields accepted input:
  - `await expect(registrationPage.emailInput).toHaveValue(testEmail)`
  - `await expect(registrationPage.passwordInput).not.toBeEmpty()`
- If terms checkbox exists, check it: `if (await registrationPage.termsCheckbox.isVisible()) { await registrationPage.termsCheckbox.check(); }`
- Assert submit button is visible and enabled (but DO NOT CLICK IT):
  - `await expect(registrationPage.submitButton).toBeVisible()`
  - `await expect(registrationPage.submitButton).toBeEnabled()`
- Add explicit comment in test: `// STOP HERE: Do NOT click submit — this validates form structure without creating real accounts`
- Log completion: `console.log('Registration flow validated — stopped before account creation');`

CRITICAL: The test MUST NOT click the submit button. This is the stop-before-payment pattern from PROJECT.md constraints. The fillForm() method in RegistrationPage already enforces this by not submitting, but the test must also explicitly not call submit.

ESM imports with .js extensions.
  </action>
  <verify>
Run `npx playwright test tests/auth/registration.spec.ts --list` — test listed.
Run `npm run typecheck` — no TypeScript errors.
Run `npx playwright test --grep @auth --list` — all 3 auth tests appear (login, session-persistence, registration).
Verify the test file does NOT contain `submitButton.click()` — grep for `.click()` on submit button must return nothing.
  </verify>
  <done>
registration.spec.ts: Test listed, imports RegistrationPage, fills form fields with test data, asserts fields accepted input, asserts submit button is visible and enabled but does NOT click it, tagged @critical @auth.
Stop-before-payment pattern enforced — no submitButton.click() in the file.
TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
- tests/auth/ directory exists with 3 spec files (login, session-persistence, registration)
- All 3 tests tagged @critical @auth
- login.spec.ts imports LoginPage and AccountPage, validates authenticated content
- session-persistence.spec.ts uses context.storageState() to verify session cookies persist
- registration.spec.ts does NOT click submit button (stop-before-payment pattern)
- All tests import page objects from tests/pages/ with .js extensions
- No networkidle or waitForTimeout in any auth test
- TypeScript compiles: `npm run typecheck` passes
</verification>

<success_criteria>
- 3 auth test spec files exist and are listed by Playwright
- Tests cover AUTH-01 (login + reach account), AUTH-02 (session persistence across navigation), AUTH-03 (registration flow without submit)
- All tests tagged @critical @auth for filtering
- Registration test enforces stop-before-payment (no submitButton.click())
- Session persistence test uses storageState API
- TypeScript compiles without errors
- No forbidden patterns (networkidle, waitForTimeout, CSS class selectors, submitButton.click in registration)
</success_criteria>

<output>
After completion, create `.planning/phases/02-critical-path-tests/02-03-SUMMARY.md`
</output>
